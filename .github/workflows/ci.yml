name: Commitizen and Git Actions

on:
  push:
    branches:
      - main

jobs:
  commitizen:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install Commitizen
      run: pip3 install -U Commitizen

    - name: Create and push new branch
      run: |
        git config --global user.email "you@example.com"
        git config --global user.name "Your Name"

        git pull origin main
        git checkout main
        git fetch --tags

        bump_output=$(cz bump --yes)

        if [[ $bump_output == *"[NO_COMMITS_TO_BUMP]"* ]]; then
            # [NO_COMMITS_TO_BUMP] message detected
            echo "No commits to bump. Skipping versioning."
        else
            # [NO_COMMITS_TO_BUMP] message not detected
            # Proceed with further processing
            echo "Commits found eligible for bumping. Proceeding with versioning."
            git branch --set-upstream-to=origin/main main
            git push origin main:$GITHUB_REF
            
            TAG=$(git describe --tags $(git rev-list --tags --max-count=1))
            echo "export TAG='$TAG'" >> variables
            git push origin $TAG
        fi
